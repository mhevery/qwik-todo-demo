/**
 * @license
 * Copyright BuilderIO All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/BuilderIO/qwik/blob/main/LICENSE
 */
/* eslint no-console: ["off"] */
import commander from 'commander';
import domino from 'domino';
import express from 'express';
import * as fs from 'fs';
import { join } from 'path';
// source-map-support seems to break node.
// import srcMap from 'source-map-support';
import { serializeState } from '@builder.io/qwik';
import { findFiles } from './fs_util.js';
import * as _module from 'module';
Object.defineProperty(_module, '_resolveFilename', (function (delegate) {
    return function (request, parent, isMain, options) {
        const ret = delegate.call(_module, request, parent, isMain, options);
        return ret;
    };
})(_module._resolveFilename));
// srcMap.install();
const RUNFILES = process.cwd();
global.__mockImport = (path) => {
    path = path.replace('file://', '');
    path = path.split('#')[0];
    const result = Promise.resolve(require(path));
    return result;
};
async function main(__dirname, process) {
    console.log('===================================================');
    console.log('Starting:', __dirname);
    console.log('Node Version:', process.version);
    const program = commander.program;
    program
        .version('0.0.1')
        .option('-p --port <port>', 'HTTP port to serve from', parseInt, 8080)
        .option('-r --root <path...>', 'List of roots to serve from', []);
    program.parse(process.argv);
    const opts = program.opts();
    console.log(opts);
    const app = express();
    app.use((req, res, next) => {
        console.log(req.path, qwikBundle.length);
        if (req.path.endsWith('/qwik.js')) {
            res.type('application/javascript');
            if (req.path == '/qwik.js') {
                res.send(qwikBundle);
            }
            else {
                res.send("export * from '/qwik.js';");
            }
        }
        else if (req.path.endsWith('/qwikloader.min.js')) {
            res.type('application/javascript');
            res.send(qwikloaderBundle);
        }
        else {
            next();
        }
    });
    // Set up static routes first
    const servePaths = opts.root.map((servePath) => join(RUNFILES, servePath));
    const qwikBundle = String(fs.readFileSync('./node_modules/@builder.io/qwik/qwik.js'));
    const qwikloaderBundle = String(fs.readFileSync('./node_modules/@builder.io/qwik/qwikloader.js'));
    servePaths.forEach((path) => {
        console.log(path);
        if (fs.existsSync(path)) {
            console.log('Serve static:', path);
            app.use('/', express.static(path));
        }
        else {
            console.log('REJECTING:', path);
        }
    });
    const serverIndexJS = [];
    opts.root.forEach(root => {
        // Hack to switch to server CJS because: https://github.com/stackblitz/webcontainer-core/issues/167c
        root = root.replace('/dist/', '/dist-server/');
        findFiles(join(RUNFILES, root), 'server_index.js', (fullPath, fileName, relativePath) => {
            console.log('Found: ', fileName, relativePath, fullPath);
            serverIndexJS.push({ url: relativePath, path: fullPath });
        });
    });
    // Now search for `server.js`
    await Promise.all(serverIndexJS.map(async (indexJS) => {
        console.log('Importing:', indexJS.path);
        try {
            const serverMain = require(indexJS.path).serverMain;
            const baseURI = `file://${indexJS.path}`;
            app.use('/' + indexJS.url, createServerJSHandler(serverMain, baseURI));
        }
        catch (e) {
            console.error(e);
        }
    }));
    app.listen(opts.port);
}
function createServerJSHandler(serverMain, baseUri) {
    return async function serverJSHandler(req, res) {
        const document = domino.createDocument();
        Object.defineProperty(document, 'baseURI', { value: baseUri });
        Object.defineProperty(document, 'URL', {
            value: `${req.protocol}://${req.headers.host}${req.originalUrl}`
        });
        const roots = await serverMain(document, req.url);
        if (!Array.isArray(roots)) {
            throw new Error(`SERVER: Render method of '${req.url}' should have returned a promise which resolves when DOM is ready for serialization.`);
        }
        serializeState(document);
        const html = document.querySelector('html');
        res.send(html.outerHTML);
    };
}
main(__dirname, process).then(() => {
    console.log('Serving ...');
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJzZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBQ0gsZ0NBQWdDO0FBQ2hDLE9BQU8sU0FBUyxNQUFNLFdBQVcsQ0FBQztBQUNsQyxPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxPQUFPLE1BQU0sU0FBUyxDQUFDO0FBQzlCLE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUIsMENBQTBDO0FBQzFDLDJDQUEyQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN6QyxPQUFPLEtBQUssT0FBTyxNQUFNLFFBQVEsQ0FBQztBQUVsQyxNQUFNLENBQUMsY0FBYyxDQUNuQixPQUFPLEVBQ1Asa0JBQWtCLEVBQ2xCLENBQUMsVUFBUyxRQUFrQjtJQUMxQixPQUFPLFVBQ0wsT0FBZSxFQUNmLE1BQVcsRUFDWCxNQUFlLEVBQ2YsT0FBWTtRQUVaLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUUsT0FBZSxDQUFDLGdCQUFnQixDQUFDLENBQ3RDLENBQUM7QUFFRixvQkFBb0I7QUFDcEIsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQzlCLE1BQWMsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRTtJQUM5QyxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFD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LEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzNCLENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7SUFDakMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUM3QixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBCdWlsZGVySU8gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2dpdGh1Yi5jb20vQnVpbGRlcklPL3F3aWsvYmxvYi9tYWluL0xJQ0VOU0VcbiAqL1xuLyogZXNsaW50IG5vLWNvbnNvbGU6IFtcIm9mZlwiXSAqL1xuaW1wb3J0IGNvbW1hbmRlciBmcm9tICdjb21tYW5kZXInO1xuaW1wb3J0IGRvbWlubyBmcm9tICdkb21pbm8nO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG4vLyBzb3VyY2UtbWFwLXN1cHBvcnQgc2VlbXMgdG8gYnJlYWsgbm9kZS5cbi8vIGltcG9ydCBzcmNNYXAgZnJvbSAnc291cmNlLW1hcC1zdXBwb3J0JztcbmltcG9ydCB7IHNlcmlhbGl6ZVN0YXRlIH0gZnJvbSAnQGJ1aWxkZXIuaW8vcXdpayc7XG5pbXBvcnQgeyBmaW5kRmlsZXMgfSBmcm9tICcuL2ZzX3V0aWwuanMnO1xuaW1wb3J0ICogYXMgX21vZHVsZSBmcm9tICdtb2R1bGUnO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoXG4gIF9tb2R1bGUsXG4gICdfcmVzb2x2ZUZpbGVuYW1lJyxcbiAgKGZ1bmN0aW9uKGRlbGVnYXRlOiBGdW5jdGlvbikge1xuICAgIHJldHVybiBmdW5jdGlvbihcbiAgICAgIHJlcXVlc3Q6IHN0cmluZyxcbiAgICAgIHBhcmVudDogYW55LFxuICAgICAgaXNNYWluOiBib29sZWFuLFxuICAgICAgb3B0aW9uczogYW55XG4gICAgKSB7XG4gICAgICBjb25zdCByZXQgPSBkZWxlZ2F0ZS5jYWxsKF9tb2R1bGUsIHJlcXVlc3QsIHBhcmVudCwgaXNNYWluLCBvcHRpb25zKTtcbiAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcbiAgfSkoKF9tb2R1bGUgYXMgYW55KS5fcmVzb2x2ZUZpbGVuYW1lKVxuKTtcblxuLy8gc3JjTWFwLmluc3RhbGwoKTtcbmNvbnN0IFJVTkZJTEVTID0gcHJvY2Vzcy5jd2QoKTtcbihnbG9iYWwgYXMgYW55KS5fX21vY2tJbXBvcnQgPSAocGF0aDogc3RyaW5nKSA9PiB7XG4gIHBhdGggPSBwYXRoLnJlcGxhY2UoJ2ZpbGU6Ly8nLCAnJyk7XG4gIHBhdGggPSBwYXRoLnNwbGl0KCcjJylbMF07XG4gIGNvbnN0IHJlc3VsdCA9IFByb21pc2UucmVzb2x2ZShyZXF1aXJlKHBhdGgpKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIG1haW4oX19kaXJuYW1lOiBzdHJpbmcsIHByb2Nlc3M6IE5vZGVKUy5Qcm9jZXNzKSB7XG4gIGNvbnNvbGUubG9nKCc9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0nKTtcbiAgY29uc29sZS5sb2coJ1N0YXJ0aW5nOicsIF9fZGlybmFtZSk7XG4gIGNvbnNvbGUubG9nKCdOb2RlIFZlcnNpb246JywgcHJvY2Vzcy52ZXJzaW9uKTtcblxuICBjb25zdCBwcm9ncmFtID0gY29tbWFuZGVyLnByb2dyYW07XG4gIHByb2dyYW1cbiAgICAudmVyc2lvbignMC4wLjEnKVxuICAgIC5vcHRpb24oJy1wIC0tcG9ydCA8cG9ydD4nLCAnSFRUUCBwb3J0IHRvIHNlcnZlIGZyb20nLCBwYXJzZUludCwgODA4MClcbiAgICAub3B0aW9uKCctciAtLXJvb3QgPHBhdGguLi4+JywgJ0xpc3Qgb2Ygcm9vdHMgdG8gc2VydmUgZnJvbScsIFtdIGFzIGFueSk7XG5cbiAgcHJvZ3JhbS5wYXJzZShwcm9jZXNzLmFyZ3YpO1xuICBjb25zdCBvcHRzOiB7IHBvcnQ6IG51bWJlcjsgcm9vdDogc3RyaW5nW10gfSA9IHByb2dyYW0ub3B0cygpIGFzIGFueTtcbiAgY29uc29sZS5sb2cob3B0cyk7XG4gIGNvbnN0IGFwcCA9IChleHByZXNzIGFzIGFueSkoKTtcblxuICBhcHAudXNlKFxuICAgIChcbiAgICAgIHJlcTogZXhwcmVzcy5SZXF1ZXN0LFxuICAgICAgcmVzOiBleHByZXNzLlJlc3BvbnNlLFxuICAgICAgbmV4dDogZXhwcmVzcy5OZXh0RnVuY3Rpb25cbiAgICApID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKHJlcS5wYXRoLCBxd2lrQnVuZGxlLmxlbmd0aCk7XG4gICAgICBpZiAocmVxLnBhdGguZW5kc1dpdGgoJy9xd2lrLmpzJykpIHtcbiAgICAgICAgcmVzLnR5cGUoJ2FwcGxpY2F0aW9uL2phdmFzY3JpcHQnKTtcbiAgICAgICAgaWYgKHJlcS5wYXRoID09ICcvcXdpay5qcycpIHtcbiAgICAgICAgICByZXMuc2VuZChxd2lrQnVuZGxlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXMuc2VuZChcImV4cG9ydCAqIGZyb20gJy9xd2lrLmpzJztcIik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAocmVxLnBhdGguZW5kc1dpdGgoJy9xd2lrbG9hZGVyLm1pbi5qcycpKSB7XG4gICAgICAgIHJlcy50eXBlKCdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0Jyk7XG4gICAgICAgIHJlcy5zZW5kKHF3aWtsb2FkZXJCdW5kbGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dCgpO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICAvLyBTZXQgdXAgc3RhdGljIHJvdXRlcyBmaXJzdFxuICBjb25zdCBzZXJ2ZVBhdGhzID0gb3B0cy5yb290Lm1hcCgoc2VydmVQYXRoOiBzdHJpbmcpID0+XG4gICAgam9pbihSVU5GSUxFUywgc2VydmVQYXRoKVxuICApO1xuICBjb25zdCBxd2lrQnVuZGxlID0gU3RyaW5nKFxuICAgIGZzLnJlYWRGaWxlU3luYygnLi9ub2RlX21vZHVsZXMvQGJ1aWxkZXIuaW8vcXdpay9xd2lrLmpzJylcbiAgKTtcblxuICBjb25zdCBxd2lrbG9hZGVyQnVuZGxlID0gU3RyaW5nKFxuICAgIGZzLnJlYWRGaWxlU3luYygnLi9ub2RlX21vZHVsZXMvQGJ1aWxkZXIuaW8vcXdpay9xd2lrbG9hZGVyLmpzJylcbiAgKTtcblxuICBzZXJ2ZVBhdGhzLmZvckVhY2goKHBhdGg6IHN0cmluZykgPT4ge1xuICAgIGNvbnNvbGUubG9nKHBhdGgpO1xuICAgIGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XG4gICAgICBjb25zb2xlLmxvZygnU2VydmUgc3RhdGljOicsIHBhdGgpO1xuICAgICAgYXBwLnVzZSgnLycsIGV4cHJlc3Muc3RhdGljKHBhdGgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coJ1JFSkVDVElORzonLCBwYXRoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbnN0IHNlcnZlckluZGV4SlM6IHsgdXJsOiBzdHJpbmc7IHBhdGg6IHN0cmluZyB9W10gPSBbXTtcbiAgb3B0cy5yb290LmZvckVhY2gocm9vdCA9PiB7XG4gICAgLy8gSGFjayB0byBzd2l0Y2ggdG8gc2VydmVyIENKUyBiZWNhdXNlOiBodHRwczovL2dpdGh1Yi5jb20vc3RhY2tibGl0ei93ZWJjb250YWluZXItY29yZS9pc3N1ZXMvMTY3Y1xuICAgIHJvb3QgPSByb290LnJlcGxhY2UoJy9kaXN0LycsICcvZGlzdC1zZXJ2ZXIvJyk7XG4gICAgZmluZEZpbGVzKFxuICAgICAgam9pbihSVU5GSUxFUywgcm9vdCksXG4gICAgICAnc2VydmVyX2luZGV4LmpzJyxcbiAgICAgIChmdWxsUGF0aDogc3RyaW5nLCBmaWxlTmFtZTogc3RyaW5nLCByZWxhdGl2ZVBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygnRm91bmQ6ICcsIGZpbGVOYW1lLCByZWxhdGl2ZVBhdGgsIGZ1bGxQYXRoKTtcbiAgICAgICAgc2VydmVySW5kZXhKUy5wdXNoKHsgdXJsOiByZWxhdGl2ZVBhdGgsIHBhdGg6IGZ1bGxQYXRoIH0pO1xuICAgICAgfVxuICAgICk7XG4gIH0pO1xuXG4gIC8vIE5vdyBzZWFyY2ggZm9yIGBzZXJ2ZXIuanNgXG4gIGF3YWl0IFByb21pc2UuYWxsKFxuICAgIHNlcnZlckluZGV4SlMubWFwKGFzeW5jIGluZGV4SlMgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ0ltcG9ydGluZzonLCBpbmRleEpTLnBhdGgpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3Qgc2VydmVyTWFpbiA9IHJlcXVpcmUoaW5kZXhKUy5wYXRoKS5zZXJ2ZXJNYWluO1xuICAgICAgICBjb25zdCBiYXNlVVJJID0gYGZpbGU6Ly8ke2luZGV4SlMucGF0aH1gO1xuICAgICAgICBhcHAudXNlKCcvJyArIGluZGV4SlMudXJsLCBjcmVhdGVTZXJ2ZXJKU0hhbmRsZXIoc2VydmVyTWFpbiwgYmFzZVVSSSkpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgfVxuICAgIH0pXG4gICk7XG5cbiAgYXBwLmxpc3RlbihvcHRzLnBvcnQpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVTZXJ2ZXJKU0hhbmRsZXIoXG4gIHNlcnZlck1haW46IChkb2M6IERvY3VtZW50LCB1cmw6IHN0cmluZykgPT4gUHJvbWlzZTxhbnlbXT4sXG4gIGJhc2VVcmk6IHN0cmluZ1xuKSB7XG4gIHJldHVybiBhc3luYyBmdW5jdGlvbiBzZXJ2ZXJKU0hhbmRsZXIoXG4gICAgcmVxOiBleHByZXNzLlJlcXVlc3QsXG4gICAgcmVzOiBleHByZXNzLlJlc3BvbnNlXG4gICkge1xuICAgIGNvbnN0IGRvY3VtZW50ID0gZG9taW5vLmNyZWF0ZURvY3VtZW50KCk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGRvY3VtZW50LCAnYmFzZVVSSScsIHsgdmFsdWU6IGJhc2VVcmkgfSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGRvY3VtZW50LCAnVVJMJywge1xuICAgICAgdmFsdWU6IGAke3JlcS5wcm90b2NvbH06Ly8ke3JlcS5oZWFkZXJzLmhvc3R9JHtyZXEub3JpZ2luYWxVcmx9YFxuICAgIH0pO1xuICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgc2VydmVyTWFpbihkb2N1bWVudCwgcmVxLnVybCk7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHJvb3RzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgU0VSVkVSOiBSZW5kZXIgbWV0aG9kIG9mICcke1xuICAgICAgICAgIHJlcS51cmxcbiAgICAgICAgfScgc2hvdWxkIGhhdmUgcmV0dXJuZWQgYSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIHdoZW4gRE9NIGlzIHJlYWR5IGZvciBzZXJpYWxpemF0aW9uLmBcbiAgICAgICk7XG4gICAgfVxuICAgIHNlcmlhbGl6ZVN0YXRlKGRvY3VtZW50KTtcbiAgICBjb25zdCBodG1sID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaHRtbCcpITtcbiAgICByZXMuc2VuZChodG1sLm91dGVySFRNTCk7XG4gIH07XG59XG5cbm1haW4oX19kaXJuYW1lLCBwcm9jZXNzKS50aGVuKCgpID0+IHtcbiAgY29uc29sZS5sb2coJ1NlcnZpbmcgLi4uJyk7XG59KTtcbiJdfQ==