/**
 * @license
 * Copyright BuilderIO All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/BuilderIO/qwik/blob/main/LICENSE
 */
/* eslint no-console: ["off"] */
import commander from 'commander';
import domino from 'domino';
import express from 'express';
import * as fs from 'fs';
import { join } from 'path';
import srcMap from 'source-map-support';
import { serializeState } from '@builder.io/qwik';
import { findFiles } from './fs_util.js';
srcMap.install();
async function main(__dirname, process) {
    console.log('===================================================');
    console.log('Starting:', __dirname);
    console.log('Node Version:', process.version);
    const program = commander.program;
    program
        .version('0.0.1')
        .option('-p --port <port>', 'HTTP port to serve from', parseInt, 8080)
        .option('-r --root <path...>', 'List of roots to serve from', []);
    program.parse(process.argv);
    const opts = program.opts();
    console.log(opts);
    const app = express();
    const RUNFILES = process.env.RUNFILES || '';
    console.log('RUNFILES', RUNFILES);
    app.use((req, res, next) => {
        if (req.path.endsWith('/qwik.js') && req.path !== '/qwik.js') {
            res.type('application/javascript');
            if (qwikBundle) {
                res.write(qwikBundle);
            }
            else {
                res.write("export * from '/qwik.js';");
            }
            res.end();
        }
        else {
            next();
        }
    });
    // Set up static routes first
    const servePaths = opts.root.map((servePath) => join(RUNFILES, servePath));
    const qwikBundle = readBundleContent(servePaths);
    servePaths.forEach((path) => {
        if (fs.existsSync(path)) {
            console.log('Serve static:', path);
            app.use('/', express.static(path));
        }
        else {
            console.log('REJECTING:', path);
        }
    });
    const serverIndexJS = [];
    opts.root.forEach(root => {
        findFiles(join(RUNFILES, root), 'server_index.js', (fullPath, fileName, relativePath) => {
            console.log('Found: ', fileName, relativePath, fullPath);
            serverIndexJS.push({ url: relativePath, path: fullPath });
        });
    });
    // Now search for `server.js`
    await Promise.all(serverIndexJS.map(async (indexJS) => {
        console.log('Importing: ', indexJS.path);
        const serverMain = (await import(indexJS.path)).serverMain;
        const baseURI = `file://${indexJS.path}`;
        app.use('/' + indexJS.url, createServerJSHandler(serverMain, baseURI));
    }));
    app.listen(opts.port);
}
function readBundleContent(paths) {
    for (let i = 0; i < paths.length; i++) {
        const path = paths[i];
        const qwikPath = join(path, 'qwik.js');
        const content = fs.readFileSync(qwikPath);
        if (content.length) {
            console.log('Found Qwik bundle:', qwikPath);
            return String(content);
        }
    }
    return null;
}
function createServerJSHandler(serverMain, baseUri) {
    return async function serverJSHandler(req, res) {
        const document = domino.createDocument();
        Object.defineProperty(document, 'baseURI', { value: baseUri });
        Object.defineProperty(document, 'URL', {
            value: `${req.protocol}://${req.headers.host}${req.originalUrl}`
        });
        const roots = await serverMain(document, req.url);
        if (!Array.isArray(roots)) {
            throw new Error(`SERVER: Render method of '${req.url}' should have returned a promise which resolves when DOM is ready for serialization.`);
        }
        serializeState(document);
        const html = document.querySelector('html');
        res.send(html.outerHTML);
    };
}
main(__dirname, process).then(() => {
    console.log('Serving ...');
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJzZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBQ0gsZ0NBQWdDO0FBQ2hDLE9BQU8sU0FBUyxNQUFNLFdBQVcsQ0FBQztBQUNsQyxPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxPQUFPLE1BQU0sU0FBUyxDQUFDO0FBQzlCLE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sRUFBVyxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckMsT0FBTyxNQUFNLE1BQU0sb0JBQW9CLENBQUM7QUFFeEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWxELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFekMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBRWpCLEtBQUssVUFBVSxJQUFJLENBQUMsU0FBaUIsRUFBRSxPQUF1QjtJQUM1RCxPQUFPLENBQUMsR0FBRyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7SUFDbkUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDcEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRTlDLE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7SUFDbEMsT0FBTztTQUNKLE9BQU8sQ0FBQyxPQUFPLENBQUM7U0FDaEIsTUFBTSxDQUFDLGtCQUFrQixFQUFFLHlCQUF5QixFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUM7U0FDckUsTUFBTSxDQUFDLHFCQUFxQixFQUFFLDZCQUE2QixFQUFFLEVBQVMsQ0FBQyxDQUFDO0lBRTNFLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLE1BQU0sSUFBSSxHQUFxQyxPQUFPLENBQUMsSUFBSSxFQUFTLENBQUM7SUFDckUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQixNQUFNLEdBQUcsR0FBSSxPQUFlLEVBQUUsQ0FBQztJQUUvQixNQUFNLFFBQVEsR0FBVyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUM7SUFDcEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFFbEMsR0FBRyxDQUFDLEdBQUcsQ0FDTCxDQUNFLEdBQW9CLEVBQ3BCLEdBQXFCLEVBQ3JCLElBQTBCLEVBQzFCLEVBQUU7UUFDRixJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssVUFBVSxFQUFFO1lBQzVELEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUNuQyxJQUFJLFVBQVUsRUFBRTtnQkFDZCxHQUFHLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQ3ZCO2lCQUFNO2dCQUNMLEdBQUcsQ0FBQyxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQzthQUN4QztZQUNELEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUNYO2FBQU07WUFDTCxJQUFJLEVBQUUsQ0FBQztTQUNSO0lBQ0gsQ0FBQyxDQUNGLENBQUM7SUFFRiw2QkFBNkI7SUFDN0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFpQixFQUFFLEVBQUUsQ0FDckQsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FDMUIsQ0FBQztJQUNGLE1BQU0sVUFBVSxHQUFHLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRWpELFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtRQUNsQyxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDbkMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ3BDO2FBQU07WUFDTCxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztTQUNqQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxhQUFhLEdBQW9DLEVBQUUsQ0FBQztJQUMxRCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUN2QixTQUFTLENBQ1AsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFDcEIsaUJBQWlCLEVBQ2pCLENBQUMsUUFBZ0IsRUFBRSxRQUFnQixFQUFFLFlBQW9CLEVBQUUsRUFBRTtZQUMzRCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ3pELGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQzVELENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7SUFFSCw2QkFBNkI7SUFDN0IsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUNmLGFBQWEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLE9BQU8sRUFBQyxFQUFFO1FBQ2hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QyxNQUFNLFVBQVUsR0FBRyxDQUFDLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztRQUMzRCxNQUFNLE9BQU8sR0FBRyxVQUFVLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN6QyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLHFCQUFxQixDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUMsQ0FBQyxDQUNILENBQUM7SUFFRixHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN4QixDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxLQUFlO0lBQ3hDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3JDLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN0QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUMsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQ2xCLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDNUMsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDeEI7S0FDRjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVELFNBQVMscUJBQXFCLENBQzVCLFVBQTBELEVBQzFELE9BQWU7SUFFZixPQUFPLEtBQUssVUFBVSxlQUFlLENBQ25DLEdBQW9CLEVBQ3BCLEdBQXFCO1FBRXJCLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN6QyxNQUFNLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUMvRCxNQUFNLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUU7WUFDckMsS0FBSyxFQUFFLEdBQUcsR0FBRyxDQUFDLFFBQVEsTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFO1NBQ2pFLENBQUMsQ0FBQztRQUNILE1BQU0sS0FBSyxHQUFHLE1BQU0sVUFBVSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDekIsTUFBTSxJQUFJLEtBQUssQ0FDYiw2QkFDRSxHQUFHLENBQUMsR0FDTixzRkFBc0YsQ0FDdkYsQ0FBQztTQUNIO1FBQ0QsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3pCLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFFLENBQUM7UUFDN0MsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDM0IsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELElBQUksQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtJQUNqQyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzdCLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEJ1aWxkZXJJTyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9CdWlsZGVySU8vcXdpay9ibG9iL21haW4vTElDRU5TRVxuICovXG4vKiBlc2xpbnQgbm8tY29uc29sZTogW1wib2ZmXCJdICovXG5pbXBvcnQgY29tbWFuZGVyIGZyb20gJ2NvbW1hbmRlcic7XG5pbXBvcnQgZG9taW5vIGZyb20gJ2RvbWlubyc7XG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IGRpcm5hbWUsIGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCBzcmNNYXAgZnJvbSAnc291cmNlLW1hcC1zdXBwb3J0JztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgc2VyaWFsaXplU3RhdGUgfSBmcm9tICdAYnVpbGRlci5pby9xd2lrJztcblxuaW1wb3J0IHsgZmluZEZpbGVzIH0gZnJvbSAnLi9mc191dGlsLmpzJztcblxuc3JjTWFwLmluc3RhbGwoKTtcblxuYXN5bmMgZnVuY3Rpb24gbWFpbihfX2Rpcm5hbWU6IHN0cmluZywgcHJvY2VzczogTm9kZUpTLlByb2Nlc3MpIHtcbiAgY29uc29sZS5sb2coJz09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PScpO1xuICBjb25zb2xlLmxvZygnU3RhcnRpbmc6JywgX19kaXJuYW1lKTtcbiAgY29uc29sZS5sb2coJ05vZGUgVmVyc2lvbjonLCBwcm9jZXNzLnZlcnNpb24pO1xuXG4gIGNvbnN0IHByb2dyYW0gPSBjb21tYW5kZXIucHJvZ3JhbTtcbiAgcHJvZ3JhbVxuICAgIC52ZXJzaW9uKCcwLjAuMScpXG4gICAgLm9wdGlvbignLXAgLS1wb3J0IDxwb3J0PicsICdIVFRQIHBvcnQgdG8gc2VydmUgZnJvbScsIHBhcnNlSW50LCA4MDgwKVxuICAgIC5vcHRpb24oJy1yIC0tcm9vdCA8cGF0aC4uLj4nLCAnTGlzdCBvZiByb290cyB0byBzZXJ2ZSBmcm9tJywgW10gYXMgYW55KTtcblxuICBwcm9ncmFtLnBhcnNlKHByb2Nlc3MuYXJndik7XG4gIGNvbnN0IG9wdHM6IHsgcG9ydDogbnVtYmVyOyByb290OiBzdHJpbmdbXSB9ID0gcHJvZ3JhbS5vcHRzKCkgYXMgYW55O1xuICBjb25zb2xlLmxvZyhvcHRzKTtcbiAgY29uc3QgYXBwID0gKGV4cHJlc3MgYXMgYW55KSgpO1xuXG4gIGNvbnN0IFJVTkZJTEVTOiBzdHJpbmcgPSBwcm9jZXNzLmVudi5SVU5GSUxFUyB8fCAnJztcbiAgY29uc29sZS5sb2coJ1JVTkZJTEVTJywgUlVORklMRVMpO1xuXG4gIGFwcC51c2UoXG4gICAgKFxuICAgICAgcmVxOiBleHByZXNzLlJlcXVlc3QsXG4gICAgICByZXM6IGV4cHJlc3MuUmVzcG9uc2UsXG4gICAgICBuZXh0OiBleHByZXNzLk5leHRGdW5jdGlvblxuICAgICkgPT4ge1xuICAgICAgaWYgKHJlcS5wYXRoLmVuZHNXaXRoKCcvcXdpay5qcycpICYmIHJlcS5wYXRoICE9PSAnL3F3aWsuanMnKSB7XG4gICAgICAgIHJlcy50eXBlKCdhcHBsaWNhdGlvbi9qYXZhc2NyaXB0Jyk7XG4gICAgICAgIGlmIChxd2lrQnVuZGxlKSB7XG4gICAgICAgICAgcmVzLndyaXRlKHF3aWtCdW5kbGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlcy53cml0ZShcImV4cG9ydCAqIGZyb20gJy9xd2lrLmpzJztcIik7XG4gICAgICAgIH1cbiAgICAgICAgcmVzLmVuZCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dCgpO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxuICAvLyBTZXQgdXAgc3RhdGljIHJvdXRlcyBmaXJzdFxuICBjb25zdCBzZXJ2ZVBhdGhzID0gb3B0cy5yb290Lm1hcCgoc2VydmVQYXRoOiBzdHJpbmcpID0+XG4gICAgam9pbihSVU5GSUxFUywgc2VydmVQYXRoKVxuICApO1xuICBjb25zdCBxd2lrQnVuZGxlID0gcmVhZEJ1bmRsZUNvbnRlbnQoc2VydmVQYXRocyk7XG5cbiAgc2VydmVQYXRocy5mb3JFYWNoKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICBpZiAoZnMuZXhpc3RzU3luYyhwYXRoKSkge1xuICAgICAgY29uc29sZS5sb2coJ1NlcnZlIHN0YXRpYzonLCBwYXRoKTtcbiAgICAgIGFwcC51c2UoJy8nLCBleHByZXNzLnN0YXRpYyhwYXRoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKCdSRUpFQ1RJTkc6JywgcGF0aCk7XG4gICAgfVxuICB9KTtcblxuICBjb25zdCBzZXJ2ZXJJbmRleEpTOiB7IHVybDogc3RyaW5nOyBwYXRoOiBzdHJpbmcgfVtdID0gW107XG4gIG9wdHMucm9vdC5mb3JFYWNoKHJvb3QgPT4ge1xuICAgIGZpbmRGaWxlcyhcbiAgICAgIGpvaW4oUlVORklMRVMsIHJvb3QpLFxuICAgICAgJ3NlcnZlcl9pbmRleC5qcycsXG4gICAgICAoZnVsbFBhdGg6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZywgcmVsYXRpdmVQYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ0ZvdW5kOiAnLCBmaWxlTmFtZSwgcmVsYXRpdmVQYXRoLCBmdWxsUGF0aCk7XG4gICAgICAgIHNlcnZlckluZGV4SlMucHVzaCh7IHVybDogcmVsYXRpdmVQYXRoLCBwYXRoOiBmdWxsUGF0aCB9KTtcbiAgICAgIH1cbiAgICApO1xuICB9KTtcblxuICAvLyBOb3cgc2VhcmNoIGZvciBgc2VydmVyLmpzYFxuICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICBzZXJ2ZXJJbmRleEpTLm1hcChhc3luYyBpbmRleEpTID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdJbXBvcnRpbmc6ICcsIGluZGV4SlMucGF0aCk7XG4gICAgICBjb25zdCBzZXJ2ZXJNYWluID0gKGF3YWl0IGltcG9ydChpbmRleEpTLnBhdGgpKS5zZXJ2ZXJNYWluO1xuICAgICAgY29uc3QgYmFzZVVSSSA9IGBmaWxlOi8vJHtpbmRleEpTLnBhdGh9YDtcbiAgICAgIGFwcC51c2UoJy8nICsgaW5kZXhKUy51cmwsIGNyZWF0ZVNlcnZlckpTSGFuZGxlcihzZXJ2ZXJNYWluLCBiYXNlVVJJKSk7XG4gICAgfSlcbiAgKTtcblxuICBhcHAubGlzdGVuKG9wdHMucG9ydCk7XG59XG5cbmZ1bmN0aW9uIHJlYWRCdW5kbGVDb250ZW50KHBhdGhzOiBzdHJpbmdbXSk6IHN0cmluZyB8IG51bGwge1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHBhdGhzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgcGF0aCA9IHBhdGhzW2ldO1xuICAgIGNvbnN0IHF3aWtQYXRoID0gam9pbihwYXRoLCAncXdpay5qcycpO1xuICAgIGNvbnN0IGNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMocXdpa1BhdGgpO1xuICAgIGlmIChjb250ZW50Lmxlbmd0aCkge1xuICAgICAgY29uc29sZS5sb2coJ0ZvdW5kIFF3aWsgYnVuZGxlOicsIHF3aWtQYXRoKTtcbiAgICAgIHJldHVybiBTdHJpbmcoY29udGVudCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVTZXJ2ZXJKU0hhbmRsZXIoXG4gIHNlcnZlck1haW46IChkb2M6IERvY3VtZW50LCB1cmw6IHN0cmluZykgPT4gUHJvbWlzZTxhbnlbXT4sXG4gIGJhc2VVcmk6IHN0cmluZ1xuKSB7XG4gIHJldHVybiBhc3luYyBmdW5jdGlvbiBzZXJ2ZXJKU0hhbmRsZXIoXG4gICAgcmVxOiBleHByZXNzLlJlcXVlc3QsXG4gICAgcmVzOiBleHByZXNzLlJlc3BvbnNlXG4gICkge1xuICAgIGNvbnN0IGRvY3VtZW50ID0gZG9taW5vLmNyZWF0ZURvY3VtZW50KCk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGRvY3VtZW50LCAnYmFzZVVSSScsIHsgdmFsdWU6IGJhc2VVcmkgfSk7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGRvY3VtZW50LCAnVVJMJywge1xuICAgICAgdmFsdWU6IGAke3JlcS5wcm90b2NvbH06Ly8ke3JlcS5oZWFkZXJzLmhvc3R9JHtyZXEub3JpZ2luYWxVcmx9YFxuICAgIH0pO1xuICAgIGNvbnN0IHJvb3RzID0gYXdhaXQgc2VydmVyTWFpbihkb2N1bWVudCwgcmVxLnVybCk7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHJvb3RzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgU0VSVkVSOiBSZW5kZXIgbWV0aG9kIG9mICcke1xuICAgICAgICAgIHJlcS51cmxcbiAgICAgICAgfScgc2hvdWxkIGhhdmUgcmV0dXJuZWQgYSBwcm9taXNlIHdoaWNoIHJlc29sdmVzIHdoZW4gRE9NIGlzIHJlYWR5IGZvciBzZXJpYWxpemF0aW9uLmBcbiAgICAgICk7XG4gICAgfVxuICAgIHNlcmlhbGl6ZVN0YXRlKGRvY3VtZW50KTtcbiAgICBjb25zdCBodG1sID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaHRtbCcpITtcbiAgICByZXMuc2VuZChodG1sLm91dGVySFRNTCk7XG4gIH07XG59XG5cbm1haW4oX19kaXJuYW1lLCBwcm9jZXNzKS50aGVuKCgpID0+IHtcbiAgY29uc29sZS5sb2coJ1NlcnZpbmcgLi4uJyk7XG59KTtcbiJdfQ==